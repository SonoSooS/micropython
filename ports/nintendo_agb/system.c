
#include <stdint.h>
#include <string.h>

#include <gba/sio.h>

#include "py/runtime.h"
#include "py/ringbuf.h"
#include "py/mphal.h"

char mp_interrupt_char;

extern uint32_t __data_start, __data_end, __data_load;
extern uint32_t __bss_start, __bss_end;

void Reset_Handler(void);
void bare_main(void);

const uint8_t isr_cart_header[0x100] __attribute__((section(".isr_vector"))) =
{
    // Jump to entrypoint (B .+0x100)
    0x3E, 0x00, 0x00, 0xEA,
    
    // Logo blob (to be replaced by external tool)
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    
    // Metadata (optional, fixed by external tool)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    
    // Multiboot header (no support, zero'd out)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

extern void sioSendSyncStr(const char* str);

extern void nsys_init_uart(void);
void mpdrv_fs_init(void);
extern int main(int argc, char **argv);

extern int uart_tx_placeholder;

static void bare_ISR_internal(void)
{
    sioSendSyncStr("mpy got IRQ\r\n");
    if(uart_tx_placeholder < 0 && !(REG_SIOCNT & (1 << 5)))
    {
        int c = REG_SIODAT8;
        #if MICROPY_KBD_EXCEPTION
        if (c == mp_interrupt_char) {
            mp_sched_keyboard_interrupt();
            return;
        }
        else
        #endif
        {
            uart_tx_placeholder = c;
        }
    }
}

__attribute__((section(".isr_vector.ISR"),target("arm"))) void bare_ISR(void)
{
    bare_ISR_internal();
}

// The CPU runs this function after a reset.
__attribute__((section(".isr_vector.start"),target("arm"),naked)) void Reset_Handler(void)
{
    if(((char *)&__data_end - (char *)&__data_start) > 0)
        memcpy(&__data_start, &__data_load, (char *)&__data_end - (char *)&__data_start);
    if(((char *)&__bss_end - (char *)&__bss_start) > 0)
        memset(&__bss_start, 0, (char *)&__bss_end - (char *)&__bss_start);
    
    uart_tx_placeholder = -1;
    nsys_init_uart();
    
    sioSendSyncStr("mpy low-level init\r\n");
    ((volatile void**)0x04000000)[-1] = bare_ISR;
    *(unsigned volatile short*)0x04000204 = (0 << 0) | (1 << 2) | (1 << 4) | (1 << 14);
    sioSendSyncStr("mpy starting\r\n");
    
    mpdrv_fs_init();
    
    main(0, NULL);
    
    sioSendSyncStr("mpy done\r\n");
    
    for(;;)
        __asm__ volatile("MOV r1, #0xFF\n\tSWI 0");
}

